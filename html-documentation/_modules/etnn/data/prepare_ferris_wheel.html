<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>etnn.data.prepare_ferris_wheel &mdash; P2_EquivariantTreeNN  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            P2_EquivariantTreeNN
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">P2_EquivariantTreeNN</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">etnn.data.prepare_ferris_wheel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for etnn.data.prepare_ferris_wheel</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">etnn</span> <span class="kn">import</span> <span class="n">TreeNode</span>
<span class="kn">from</span> <span class="nn">etnn.data</span> <span class="kn">import</span> <span class="n">DEFAULT_DATA_PATH</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">etnn.data.ferris_score_helpers</span> <span class="kn">import</span> <span class="n">build_wheel_happyness</span><span class="p">,</span> <span class="n">build_generative_label</span><span class="p">,</span> <span class="n">build_label_tree</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">multiprocess.pool</span> <span class="kn">import</span> <span class="n">Pool</span>


<div class="viewcode-block" id="prepare_1_ferris">
<a class="viewcode-back" href="../../../etnn.data.html#etnn.data.prepare_ferris_wheel.prepare_1_ferris">[docs]</a>
<span class="k">def</span> <span class="nf">prepare_1_ferris</span><span class="p">(</span>
        <span class="n">df_name_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Sleep_health_and_lifestyle_dataset.csv&quot;</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DATA_PATH</span><span class="p">,</span>
        <span class="n">df_name_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;health_dataset_preprocessed-1.csv&#39;</span><span class="p">,</span>
        <span class="n">try_pregen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that preprocesses the person health dataset once in respect to creating the ferris wheel dataset.</span>

<span class="sd">    :param df_name_input: name of the dataframe to process, default: ``Sleep_health_and_lifestyle_dataset.csv``.</span>
<span class="sd">    :type df_name_input: str</span>
<span class="sd">    :param dataset_path: Path to the dataset folder, default: ``DEFAULT_DATA_PATH``</span>
<span class="sd">    :type dataset_path: str</span>
<span class="sd">    :param df_name_output: name of the file into which to save the preprocessed dataset, default:</span>
<span class="sd">        ``health_dataset_preprocessed-1.csv``.</span>
<span class="sd">    :type df_name_output: str</span>
<span class="sd">    :param try_pregen: determines whether a pre-existing preprocessed data file should be used or not, default: ``True``</span>
<span class="sd">    :type try_pregen: bool</span>
<span class="sd">    :return: dataframe containing the preprocessed data</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># CHECK IF PRECOMPUTED</span>
    <span class="k">if</span> <span class="n">try_pregen</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">df_name_output</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">df_name_output</span><span class="p">))</span>

    <span class="c1"># LOADING</span>
    <span class="c1"># join path</span>
    <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">df_name_input</span><span class="p">)</span>

    <span class="c1"># define column names (old ones unsuitable for d.col_name usage)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;sleep_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;sleep_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;physical_activity&#39;</span><span class="p">,</span> <span class="s1">&#39;stress_level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bmi&#39;</span><span class="p">,</span> <span class="s1">&#39;blood_pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;daily_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;sleep_disorder&#39;</span>
    <span class="p">]</span>

    <span class="c1"># load dataset</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">df_path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># REPLACE NAN VALUES</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sleep_disorder</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># CONVERT TEXT FIELDS INTO INTEGER VALUES</span>
    <span class="c1"># bmi</span>
    <span class="n">bmi_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Normal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;Normal Weight&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;Overweight&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;Obese&#39;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
    <span class="n">df</span><span class="o">.</span><span class="n">bmi</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">bmi</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">bmi_dict</span><span class="p">)</span>

    <span class="c1"># blood pressure</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;blood_pressure1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">blood_pressure</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;blood_pressure2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">blood_pressure</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;blood_pressure&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># occupation</span>
    <span class="n">occ</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">occupation</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">occ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">occ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">occ</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">occupation</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">occupation</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">occ</span><span class="p">)</span>

    <span class="c1"># sleep</span>
    <span class="n">sleep_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;No&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;Sleep Apnea&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;Insomnia&#39;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sleep_disorder</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sleep_disorder</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sleep_dict</span><span class="p">)</span>

    <span class="c1"># gender</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gender_male&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">gender</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Male&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gender_female&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">gender</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Female&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gender_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">gender_female</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">gender_male</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">df_name_output</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="normalize_dataset">
<a class="viewcode-back" href="../../../etnn.data.html#etnn.data.prepare_ferris_wheel.normalize_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">normalize_dataset</span><span class="p">(</span>
        <span class="n">df_health</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the provided dataset with sklearn min max scaler. Excludes a possible ``&#39;id&#39;`` column.</span>

<span class="sd">    :param df_health: dataframe to be normalized.</span>
<span class="sd">    :type df_health: pd.DataFrame</span>
<span class="sd">    :return: normalized dataframe</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df_health</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">x</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols</span>
        <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="o">!=</span> <span class="n">x</span>
    <span class="p">]</span>

    <span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>

    <span class="n">scaler</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">MinMaxScaler</span><span class="p">()</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df_health</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">df_out</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_health</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_out</span></div>



<div class="viewcode-block" id="generate_ferris_dataset">
<a class="viewcode-back" href="../../../etnn.data.html#etnn.data.prepare_ferris_wheel.generate_ferris_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">generate_ferris_dataset</span><span class="p">(</span>
        <span class="n">num_gondolas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">num_part_pg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">num_to_generate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1_000</span><span class="p">,</span>
        <span class="n">df_name_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Sleep_health_and_lifestyle_dataset.csv&quot;</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DATA_PATH</span><span class="p">,</span>
        <span class="n">df_intermediate_output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;health_dataset_preprocessed-1.csv&#39;</span><span class="p">,</span>
        <span class="n">try_pregen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4651431</span><span class="p">,</span>
        <span class="n">label_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="n">final_label_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that generates the ferris dataset&#39;s core dataset, the health dataset and the index dataset.</span>

<span class="sd">    :param num_gondolas: number of gondolas the ferris wheel should have, default: ``10``</span>
<span class="sd">    :type num_gondolas: int</span>
<span class="sd">    :param num_part_pg: number of people in each gondola, default: ``5``</span>
<span class="sd">    :type num_part_pg: int</span>
<span class="sd">    :param num_to_generate: number of elements the core dataset should have, default: ``1000``</span>
<span class="sd">    :type num_to_generate:  int</span>
<span class="sd">    :param df_name_input: name of the dataset input, default: ``Sleep_health_and_lifestyle_dataset.csv``</span>
<span class="sd">    :type df_name_input: str</span>
<span class="sd">    :param dataset_path: path to dataset folder, default: ``DEFAULT_DATA_PATH``</span>
<span class="sd">    :type dataset_path: str</span>
<span class="sd">    :param df_intermediate_output_name: name of intermediate dataset csv, default: ``health_dataset_preprocessed-1.csv``</span>
<span class="sd">    :type df_intermediate_output_name: str</span>
<span class="sd">    :param try_pregen: determines whether it shall be attempted to load the pre-generated csv files, default: ``True``</span>
<span class="sd">    :type try_pregen: bool</span>
<span class="sd">    :param seed: seed to be used for random generation procedures</span>
<span class="sd">    :type seed: int</span>
<span class="sd">    :param label_type: label to be generated. Viable options: ``&#39;default&#39;`` producing the most complex label with logic</span>
<span class="sd">        inspired by a real ferris wheel, ``&#39;tree&#39;`` and ``&#39;tree_advanced&#39;`` for a tree based generation of label with</span>
<span class="sd">        minimal logic behind this label. Difference in first and second tree option is that the first option is a</span>
<span class="sd">        downgraded version only using S and P type labels and not C type labels instead of C as it would have been</span>
<span class="sd">        intended for a ferris wheel dataset, default: ``&#39;default&#39;``.</span>
<span class="sd">    :type label_type: str</span>
<span class="sd">    :param final_label_factor: Factor by which the label is scaled. Does not apply for ``&#39;default&#39;`` option in</span>
<span class="sd">        label_type parameter. Default: ``1/1000``</span>
<span class="sd">    :type final_label_factor: float</span>
<span class="sd">    :param normalize: Whether or not the data is normalized with a min-max scaler, default: ``False``</span>
<span class="sd">    :type normalize: bool</span>
<span class="sd">    :return: health dataset and index dataset</span>
<span class="sd">    :rtype: typing.Tuple[pd.DataFrame, pd.DataFrame]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set seed if not none</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># load dataset which is the base of the data generation</span>
    <span class="n">df_health</span> <span class="o">=</span> <span class="n">prepare_1_ferris</span><span class="p">(</span>
        <span class="n">df_name_input</span><span class="o">=</span><span class="n">df_name_input</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span>
        <span class="n">df_name_output</span><span class="o">=</span><span class="n">df_intermediate_output_name</span><span class="p">,</span>
        <span class="n">try_pregen</span><span class="o">=</span><span class="n">try_pregen</span>
    <span class="p">)</span>

    <span class="c1"># if normalize - normalize dataset</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">df_health</span> <span class="o">=</span> <span class="n">normalize_dataset</span><span class="p">(</span><span class="n">df_health</span><span class="p">)</span>

    <span class="c1"># see if file already exists and load this</span>
    <span class="c1"># file name logic</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ferris-wheel_g-</span><span class="si">{</span><span class="n">num_gondolas</span><span class="si">}</span><span class="s2">_p-</span><span class="si">{</span><span class="n">num_part_pg</span><span class="si">}</span><span class="s2">_size-</span><span class="si">{</span><span class="n">num_to_generate</span><span class="si">}</span><span class="s2">_seed-</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">_label-</span><span class="si">{</span><span class="n">label_type</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">final_label_factor</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-normalized&quot;</span>
    <span class="n">file_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;.csv&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">try_pregen</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">df_health</span>

    <span class="c1"># else generate it</span>
    <span class="c1"># init ordering array</span>
    <span class="n">random_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_health</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># initialize dataset storage</span>
    <span class="n">dataset_storage</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_store</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># produce a number of elements</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_to_generate</span><span class="p">)):</span>
        <span class="c1"># generate sample element</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">random_order</span><span class="p">)</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">random_order</span><span class="p">[:</span><span class="n">num_gondolas</span><span class="o">*</span><span class="n">num_part_pg</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_gondolas</span><span class="p">,</span> <span class="n">num_part_pg</span><span class="p">)</span>

        <span class="n">data_store</span> <span class="o">+=</span> <span class="p">[</span><span class="n">sample</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

    <span class="c1"># calc label</span>
    <span class="k">if</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s2">&quot;tree&quot;</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">build_label_tree</span><span class="p">(</span>
            <span class="n">df_health</span><span class="o">=</span><span class="n">df_health</span><span class="p">,</span>
            <span class="n">map_element</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">num_gondolas</span><span class="o">=</span><span class="n">num_gondolas</span><span class="p">,</span>
            <span class="n">num_part_pg</span><span class="o">=</span><span class="n">num_part_pg</span><span class="p">,</span>
            <span class="n">final_label_factor</span><span class="o">=</span><span class="n">final_label_factor</span><span class="o">*</span><span class="mi">1000</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="n">final_label_factor</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)]</span>

    <span class="k">elif</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s2">&quot;tree_advanced&quot;</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">build_label_tree</span><span class="p">(</span>
            <span class="n">df_health</span><span class="o">=</span><span class="n">df_health</span><span class="p">,</span>
            <span class="n">map_element</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">num_gondolas</span><span class="o">=</span><span class="n">num_gondolas</span><span class="p">,</span>
            <span class="n">num_part_pg</span><span class="o">=</span><span class="n">num_part_pg</span><span class="p">,</span>
            <span class="n">final_label_factor</span><span class="o">=</span><span class="n">final_label_factor</span><span class="o">*</span><span class="mi">1000</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="n">final_label_factor</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">build_wheel_happyness</span><span class="p">(</span><span class="n">df_health</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">dataset_storage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_store</span><span class="p">)))</span>

    <span class="c1"># dataset_storage = list(map(func, tqdm(data_store)))</span>

    <span class="c1"># fuze dataset</span>
    <span class="n">df_generated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">dataset_storage</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;g-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_p-</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_gondolas</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_part_pg</span><span class="p">)</span>
                <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># save dataset</span>
    <span class="n">df_generated</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_generated</span><span class="p">,</span> <span class="n">df_health</span></div>



<div class="viewcode-block" id="generate_ferris_dataset_single_node">
<a class="viewcode-back" href="../../../etnn.data.html#etnn.data.prepare_ferris_wheel.generate_ferris_dataset_single_node">[docs]</a>
<span class="k">def</span> <span class="nf">generate_ferris_dataset_single_node</span><span class="p">(</span>
        <span class="n">node_type</span><span class="p">,</span>
        <span class="n">num_elem</span><span class="p">,</span>
        <span class="n">num_to_generate</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">,</span>
        <span class="n">final_label_factor</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">,</span>
        <span class="n">df_name_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Sleep_health_and_lifestyle_dataset.csv&quot;</span><span class="p">,</span>
        <span class="n">df_intermediate_output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;health_dataset_preprocessed-1.csv&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that creates a dataset and data fame for generating data generated with the logic of a permutation tree</span>
<span class="sd">    with a singular node as its root with all elements.</span>

<span class="sd">    :param node_type: Type of the label of the singular permutation tree in its defining permutation tree. Determines</span>
<span class="sd">        how the label is generated.</span>
<span class="sd">    :type node_type: str</span>
<span class="sd">    :param num_elem: Number of elements to be grouped belonging to the singular permutation tree node.</span>
<span class="sd">    :type num_elem: int</span>
<span class="sd">    :param num_to_generate: number of elements to generate for the dataset.</span>
<span class="sd">    :type num_to_generate: int</span>
<span class="sd">    :param dataset_path: path to the dataset folder</span>
<span class="sd">    :type dataset_path: str</span>
<span class="sd">    :param final_label_factor: final label to be applied to the original label, default: ``1/1000``.</span>
<span class="sd">    :type final_label_factor: float</span>
<span class="sd">    :param normalize: bool controlling whether the input data with person health data should be normalized or not.</span>
<span class="sd">    :type normalize: bool</span>
<span class="sd">    :param seed: seed to make experiments reproducible, default: ``4651431``.</span>
<span class="sd">    :type seed: int</span>
<span class="sd">    :param df_name_input: name of the dataframe to load, default: ``&#39;Sleep_health_and_lifestyle_dataset.csv&#39;``.</span>
<span class="sd">    :type df_name_input: str</span>
<span class="sd">    :param df_intermediate_output_name: name of the intermediate (preprocessed) data to produce and store or load.</span>
<span class="sd">        Default: ``&#39;health_dataset_preprocessed-1.csv&#39;``.</span>
<span class="sd">    :type df_intermediate_output_name: str</span>
<span class="sd">    :return: dataset and data frame containing structural information</span>
<span class="sd">    :rtype: typing.Tuple[torch.utils.data.Dataset, pd.DataFrame]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set seed if not none</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># load dataset which is the base of the data generation</span>
    <span class="n">df_health</span> <span class="o">=</span> <span class="n">prepare_1_ferris</span><span class="p">(</span>
        <span class="n">df_name_input</span><span class="o">=</span><span class="n">df_name_input</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span>
        <span class="n">df_name_output</span><span class="o">=</span><span class="n">df_intermediate_output_name</span><span class="p">,</span>
        <span class="n">try_pregen</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># if normalize - normalize dataset</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">df_health</span> <span class="o">=</span> <span class="n">normalize_dataset</span><span class="p">(</span><span class="n">df_health</span><span class="p">)</span>

    <span class="c1"># see if file already exists and load this</span>
    <span class="c1"># file name logic</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ferris-wheel_e-</span><span class="si">{</span><span class="n">num_elem</span><span class="si">}</span><span class="s2">-type-</span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2">_size-</span><span class="si">{</span><span class="n">num_to_generate</span><span class="si">}</span><span class="s2">_seed-</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">final_label_factor</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-normalized&quot;</span>
    <span class="n">file_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;.csv&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">df_health</span>

    <span class="c1"># else generate it</span>
    <span class="c1"># init ordering array</span>
    <span class="n">random_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_health</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># initialize dataset storage</span>
    <span class="n">dataset_storage</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_store</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># produce a number of elements</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_to_generate</span><span class="p">)):</span>
        <span class="c1"># generate sample element</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">random_order</span><span class="p">)</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">random_order</span><span class="p">[:</span><span class="n">num_elem</span><span class="p">]</span>

        <span class="n">data_store</span> <span class="o">+=</span> <span class="p">[</span><span class="n">sample</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

    <span class="c1"># calc label</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">final_label_factor</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="n">final_label_factor</span>
    <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">build_generative_label</span><span class="p">(</span>
        <span class="n">tree</span><span class="o">=</span><span class="n">TreeNode</span><span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="p">[</span><span class="n">TreeNode</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="n">num_elem</span><span class="p">)]),</span>
        <span class="n">df_health</span><span class="o">=</span><span class="n">df_health</span><span class="p">,</span>
        <span class="n">map_element</span><span class="o">=</span><span class="n">x</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">factor</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">dataset_storage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_store</span><span class="p">)))</span>

    <span class="c1"># dataset_storage = list(map(func, tqdm(data_store)))</span>
    <span class="c1">#dataset_storage = [</span>
    <span class="c1">#    build_generative_label(</span>
    <span class="c1">#        tree=TreeNode(node_type, [TreeNode(&quot;E&quot;, num_elem)]),</span>
    <span class="c1">#        df_health=df_health,</span>
    <span class="c1">#        map_element=x</span>
    <span class="c1">#    ).sum()</span>
    <span class="c1">#    for x in data_store</span>
    <span class="c1">#]</span>

    <span class="c1"># fuze dataset</span>
    <span class="n">df_generated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">dataset_storage</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;e-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_elem</span><span class="p">)</span>
                <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># save dataset</span>
    <span class="n">df_generated</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_generated</span><span class="p">,</span> <span class="n">df_health</span></div>



<div class="viewcode-block" id="add_valid_permutations">
<a class="viewcode-back" href="../../../etnn.data.html#etnn.data.prepare_ferris_wheel.add_valid_permutations">[docs]</a>
<span class="k">def</span> <span class="nf">add_valid_permutations</span><span class="p">(</span>
        <span class="n">num_add_equal_elem</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">df_index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">num_gondolas</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4354353</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that permutes some sampled elements in the index dataframe and adds them with the correct value to the</span>
<span class="sd">    dataframe that is returned.</span>

<span class="sd">    :param num_add_equal_elem: number of equivariant elements to add</span>
<span class="sd">    :type num_add_equal_elem: int</span>
<span class="sd">    :param df_index: dataframe from which to sample elements and which to enlarge with this operations newly permutated</span>
<span class="sd">        elements</span>
<span class="sd">    :type df_index: pd.DataFrame</span>
<span class="sd">    :param num_gondolas: number of gondolas the ferris wheel has</span>
<span class="sd">    :type num_gondolas: int</span>
<span class="sd">    :param seed: seed to use for random permutation operations</span>
<span class="sd">    :type seed: int</span>
<span class="sd">    :return: the enlarged df_index dataset with correctly labeled elements</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="n">df_index</span>

    <span class="n">remaining_to_generate</span> <span class="o">=</span> <span class="n">num_add_equal_elem</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pd_new</span> <span class="o">=</span> <span class="n">sample_new_permutations</span><span class="p">(</span>
            <span class="n">df_index</span><span class="o">=</span><span class="n">merged</span><span class="p">,</span>
            <span class="n">num_elem</span><span class="o">=</span><span class="n">remaining_to_generate</span><span class="p">,</span>
            <span class="n">num_gondolas</span><span class="o">=</span><span class="n">num_gondolas</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># concatenate and return</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">df_index</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pd_new</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">remaining_to_generate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_merge&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remaining_to_generate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_index</span><span class="p">,</span> <span class="n">pd_new</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="sample_new_permutations">
<a class="viewcode-back" href="../../../etnn.data.html#etnn.data.prepare_ferris_wheel.sample_new_permutations">[docs]</a>
<span class="k">def</span> <span class="nf">sample_new_permutations</span><span class="p">(</span>
        <span class="n">df_index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">num_elem</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_gondolas</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">merge_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to create permutations to the ferris wheel dataset and returning it as a pandas DataFrame.</span>

<span class="sd">    :param df_index: dataframe which elements to sample and randomly permute</span>
<span class="sd">    :type df_index: pd.DataFrame</span>
<span class="sd">    :param num_elem: number of elements to create</span>
<span class="sd">    :type num_elem: int</span>
<span class="sd">    :param num_gondolas: number of gondolas the dataset has. can be also read from the dataframe by the column names</span>
<span class="sd">        but not used in this method</span>
<span class="sd">    :type num_gondolas: int</span>
<span class="sd">    :param seed: seed to use to control randomness, default: ``None``</span>
<span class="sd">    :type seed: int</span>
<span class="sd">    :param merge_check: boolean parameters controlling whether a merge check should be performed. A merge check contains</span>
<span class="sd">        whether it should be checked if the random permutation produced an element which is already in df_index</span>
<span class="sd">    :type merge_check: bool</span>
<span class="sd">    :return: pandas dataframe containing the newly created elements</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create viable permutations of input and add them to dataset</span>
    <span class="c1"># sample elements to perturb</span>
    <span class="n">df_sampled</span> <span class="o">=</span> <span class="n">df_index</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_elem</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># for each randomly one of two things:</span>
    <span class="c1"># - group order change</span>
    <span class="c1">#   + shift groups</span>
    <span class="c1">#   + invert group order (left out for now as easier this way)</span>
    <span class="c1"># - permutate gondola people</span>

    <span class="c1"># convert to numpy</span>
    <span class="n">df_t</span> <span class="o">=</span> <span class="n">df_sampled</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="nb">int</span><span class="p">)[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># changing shape to make dimensions match ferris wheel structure</span>
    <span class="n">df_g</span> <span class="o">=</span> <span class="n">df_t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">df_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_gondolas</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># create shifts and index</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_gondolas</span><span class="p">,</span> <span class="n">df_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_gondolas</span><span class="p">)</span>

    <span class="c1"># perturbing elements in numpy array in manner of C and P</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_elem</span><span class="p">)):</span>
        <span class="n">df_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_g</span><span class="p">[</span><span class="n">i</span><span class="p">][(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="n">num_gondolas</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_gondolas</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">df_g</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

    <span class="c1"># create dataset out of perturbed elements</span>
    <span class="n">pd_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">df_t</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">df_sampled</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">pd_new</span><span class="p">[</span><span class="n">df_sampled</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_sampled</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">merge_check</span><span class="p">:</span>
        <span class="n">merge_checked</span> <span class="o">=</span> <span class="n">pd_new</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_index</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">num_duplicate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">merge_checked</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>

        <span class="n">good_samples</span> <span class="o">=</span> <span class="n">merge_checked</span><span class="p">[</span><span class="n">merge_checked</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;left_only&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">good_samples</span> <span class="o">=</span> <span class="n">good_samples</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_merge&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">merge_checked</span> <span class="o">=</span> <span class="n">merge_checked</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_merge&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_duplicate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">good_samples</span>

        <span class="c1"># get replacements for the duplicates</span>
        <span class="n">new_samples</span> <span class="o">=</span> <span class="n">sample_new_permutations</span><span class="p">(</span>
            <span class="n">df_index</span><span class="o">=</span><span class="n">merge_checked</span><span class="p">,</span>
            <span class="n">num_elem</span><span class="o">=</span><span class="n">num_duplicate</span><span class="p">,</span>
            <span class="n">num_gondolas</span><span class="o">=</span><span class="n">num_gondolas</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span><span class="p">),</span>
            <span class="n">merge_check</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">good_samples</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">new_samples</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd_new</span></div>



<div class="viewcode-block" id="add_invalid_permutations">
<a class="viewcode-back" href="../../../etnn.data.html#etnn.data.prepare_ferris_wheel.add_invalid_permutations">[docs]</a>
<span class="k">def</span> <span class="nf">add_invalid_permutations</span><span class="p">(</span>
        <span class="n">num_add_nequal_elem</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">df_index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">num_gondolas</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4354353</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that permutes some sampled elements in the index dataframe and adds them with the perturbed value to the</span>
<span class="sd">    dataframe that is returned.</span>

<span class="sd">    :param num_add_nequal_elem: number of equivariant elements to add (with perturbed label)</span>
<span class="sd">    :type num_add_nequal_elem: int</span>
<span class="sd">    :param df_index: dataframe from which to sample elements and which to enlarge with this operations newly permutated</span>
<span class="sd">        elements</span>
<span class="sd">    :type df_index: pd.DataFrame</span>
<span class="sd">    :param num_gondolas: number of gondolas the ferris wheel has</span>
<span class="sd">    :type num_gondolas: int</span>
<span class="sd">    :param seed: seed to use for random permutation operations</span>
<span class="sd">    :type seed: int</span>
<span class="sd">    :return: the enlarged df_index dataset with falsely labeled elements</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create viable permutations of input and add them to dataset</span>
    <span class="c1"># sample elements to perturb</span>
    <span class="n">df_sampled</span> <span class="o">=</span> <span class="n">df_index</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_add_nequal_elem</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># for each randomly one of two things:</span>
    <span class="c1"># - group order change</span>
    <span class="c1">#   + shift groups</span>
    <span class="c1">#   + invert group order (left out for now as easier this way)</span>
    <span class="c1"># - permutate gondola people</span>

    <span class="c1"># convert to numpy</span>
    <span class="n">df_t</span> <span class="o">=</span> <span class="n">df_sampled</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># changing shape to make dimensions match ferris wheel structure</span>
    <span class="n">df_g</span> <span class="o">=</span> <span class="n">df_t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">df_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_gondolas</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># create shifts and index</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_gondolas</span><span class="p">,</span> <span class="n">df_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_gondolas</span><span class="p">)</span>

    <span class="c1"># perturbing elements in numpy array in manner of C and P</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_add_nequal_elem</span><span class="p">)):</span>
        <span class="n">df_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_g</span><span class="p">[</span><span class="n">i</span><span class="p">][(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="n">num_gondolas</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_gondolas</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">df_g</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

    <span class="c1"># create dataset out of perturbed elements</span>
    <span class="n">pd_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span>
            <span class="n">df_t</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_t</span><span class="p">))</span><span class="o">*</span><span class="mi">20</span>
        <span class="p">],</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">df_sampled</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">)</span>

    <span class="c1"># concatenate and return</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_index</span><span class="p">,</span> <span class="n">pd_new</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Johannes P. Urban, B.Sc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>